import java.text.SimpleDateFormat

apply plugin: 'com.android.application'
apply plugin: 'kotlin-android'
apply plugin: 'kotlin-android-extensions'

def SEPARATOR = '--------------------'
def branchName = System.getProperty('branchName', project.getProperties().get('branchName', ''))
def commitHash
def buildTime = (new SimpleDateFormat("dd-MMM-yyyy hh:mm aa")).format(new Date())

// RATIONALE: XX MM VV A PPP
// XX -> BUILD TOOL VERSION
// MM -> MIN SDK SUPPORT
// VV -> MAJOR APP VERSION
//  A -> MINOR APP VERSION
// PP -> PATCH VERSION
// eg. (271601000) -> BUILD TOOLS: 27 | MIN SDK VER: 16 | MAJOR APP VER: 01 | MINOR APP VERSION: 0 | PATCH VERSION: 00
def appVersionCode = 271601000
def appVersionName = "1.0.0"
def final defaultApplicationId = "com.sample_package_name.sample_application_name"
def final defaultAppName = "MyApplication"

try {
    if (branchName == '') {
        branchName = "git rev-parse --abbrev-ref HEAD".execute().text.trim()
    }
    if (branchName.contains("/"))
        branchName = branchName.replace("/", "_")
    if (branchName.contains("-"))
        branchName = branchName.replace("-", "_")

    def commitHashString = "git log --format=\"%H\" -n 1".execute().text
    commitHash = commitHashString.substring(1, commitHashString.length() - 2)

    println SEPARATOR
    println "BRANCH NAME: " + branchName
    println "COMMIT HASH: " + commitHash
    println "BUILD TIME: " + buildTime
    println SEPARATOR

} catch (Exception ignored) {
    println "Git not found"
    println SEPARATOR
}

android {
    compileSdkVersion project.ANDROID_BUILD_SDK_VERSION.toInteger()

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }

    defaultConfig {
        applicationId  = defaultApplicationId
        manifestPlaceholders = [ appName: "${defaultAppName}"]

        buildConfigField("String", "APP_VERSION_NAME", "\"${appVersionName}\"")
        buildConfigField("String", "APP_VERSION_CODE", "\"${appVersionCode}\"")
        buildConfigField("String", "BRANCH_NAME", "\"${branchName}\"")
        buildConfigField("String", "COMMIT_HASH", "\"${commitHash}\"")
        buildConfigField("String", "BUILD_TIME", "\"${buildTime}\"")

        applicationVariants.all { variant ->
            def fileName = "--V" + variant.versionName + "--" + branchName + ".apk"
            variant.outputs.each { output ->
                output.outputFileName = output.outputFileName.replace(".apk", fileName)
            }
        }

        multiDexEnabled true

        minSdkVersion project.ANDROID_BUILD_MIN_SDK_VERSION.toInteger()
        targetSdkVersion project.ANDROID_BUILD_TARGET_SDK_VERSION.toInteger()
        versionCode appVersionCode
        versionName appVersionName
        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
    }

    buildTypes {
        release {
            minifyEnabled true
            zipAlignEnabled true
            shrinkResources true
            useProguard true
            debuggable false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
            manifestPlaceholders = [appNameSuffix: ""]
        }

        debug {
            manifestPlaceholders = [ appNameSuffix:" v${appVersionName}"]
            applicationIdSuffix ".debug"
        }
    }

    buildToolsVersion project.ANDROID_BUILD_TOOLS_VERSION

    productFlavors {
    }
}

dependencies {
    implementation fileTree(dir: 'libs', include: ['*.jar'])
    implementation "androidx.appcompat:appcompat:${project.ANDROIDX_SUPPORT_LIB_VERSION}"
    implementation "androidx.legacy:legacy-support-v4:${project.ANDROIDX_SUPPORT_LIB_VERSION}"
    // implementation "com.google.android.material:material:${project.ANDROIDX_SUPPORT_LIB_VERSION}"
    // implementation "androidx.gridlayout:gridlayout:${project.ANDROIDX_SUPPORT_LIB_VERSION}"

    testImplementation 'junit:junit:4.12'
    androidTestImplementation 'androidx.test:runner:1.2.0'
    androidTestImplementation 'androidx.test.espresso:espresso-core:3.2.0'

    // Kotlin
    implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk7:${project.KOTLIN_VERSION}"

    // EventBus
    implementation 'org.greenrobot:eventbus:3.1.1'

    // Carbon
    implementation 'tk.zielony:carbon:0.16.0.1'

    // Stetho
    implementation 'com.facebook.stetho:stetho:1.5.0'

    // Butterknife
    // implementation 'com.jakewharton:butterknife:10.1.0'
    // annotationProcessor 'com.jakewharton:butterknife-compiler:10.1.0'

    // Lombok
    // compileOnly 'org.projectlombok:lombok:1.18.2'
    // annotationProcessor 'org.projectlombok:lombok:1.18.2'
}
repositories {
    mavenCentral()
}
